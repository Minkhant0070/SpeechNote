<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Note - အသံဖြင့် မှတ်စုရေးမယ် (Smart Formatting)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Myanmar:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans Myanmar', sans-serif;
            background-color: #f0f2f5;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .pulsate {
            animation: pulsate 1.5s infinite;
        }
        @keyframes pulsate {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 10px 20px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .note-item:hover .delete-icon {
            opacity: 1;
        }
        .note-item.selected {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3B82F6;
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .control-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 300ms ease-out;
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 200ms ease-in;
        }
        .grid-note-card {
            overflow-wrap: break-word;
        }
        .tag-badge {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tag-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold text-center mb-2">ကြိုဆိုပါတယ်၊ မင်းခန့်</h2>
            <p class="text-center text-gray-600 mb-6">စတင်အသုံးပြုရန် သင်၏ Gemini API Key ကိုထည့်သွင်းပါ။</p>
            <div class="space-y-4">
                <input type="password" id="apiKeyInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="သင်၏ API Key ကိုဤနေရာတွင်ထည့်ပါ">
                <button id="saveApiKeyBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                    API Key ကို သိမ်းဆည်းမည်
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-4 text-center">သင်၏ API Key ကို သင့်ဘရောက်ဆာတွင်သာ သိမ်းဆည်းမည်ဖြစ်ပြီး ကျွန်ုပ်တို့မှ ရယူသုံးစွဲမည်မဟုတ်ပါ။</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Voice Note <span class="text-blue-600 text-xl font-semibold">Smart Format</span></h1>
                <button id="changeApiKeyBtn" class="text-sm text-blue-600 hover:underline">API Key ပြောင်းမည်</button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Recording Panel -->
                    <div class="glassmorphism rounded-2xl p-6 shadow-lg flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <label for="languageSelect" class="font-medium">ဘာသာစကား:</label>
                            <select id="languageSelect" class="bg-white border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="my-MM" data-lang-name="Burmese">မြန်မာ (Myanmar)</option>
                                <option value="en-US" data-lang-name="English">အင်္ဂလိပ် (English)</option>
                                <option value="es-ES" data-lang-name="Spanish">စပိန် (Spanish)</option>
                                <option value="zh-CN" data-lang-name="Chinese">တရုတ် (Mandarin)</option>
                                <option value="hi-IN" data-lang-name="Hindi">ဟိန္ဒီ (Hindi)</option>
                                <option value="fr-FR" data-lang-name="French">ပြင်သစ် (French)</option>
                                <option value="ar-SA" data-lang-name="Arabic">အာရပ် (Arabic)</option>
                                <option value="ja-JP" data-lang-name="Japanese">ဂျပန် (Japanese)</option>
                                <option value="de-DE" data-lang-name="German">ဂျာမန် (German)</option>
                                <option value="ko-KR" data-lang-name="Korean">ကိုရီးယား (Korean)</option>
                            </select>
                        </div>
                        <div id="recordingModule" class="flex items-center gap-4">
                             <button id="uploadBtn" class="bg-gray-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg transform hover:scale-105 transition-transform duration-300" title="အသံဖိုင် တင်ရန်">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                             </button>
                             <input type="file" id="audioUpload" class="hidden" accept="audio/*">
                             <div id="recordingControls">
                                <button id="recordBtn" class="bg-red-500 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg transform hover:scale-105 transition-transform duration-300" title="အသံစတင်သွင်းရန်">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H7v1h6v-1h-2v-2.07z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            <div id="loadingSpinner" class="hidden w-16 h-16 flex items-center justify-center">
                                 <div class="spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                            </div>
                            <p id="recordingStatus" class="text-gray-600 h-6 text-center"></p>
                        </div>
                    </div>
                    <!-- Editor Panel -->
                    <div class="glassmorphism rounded-2xl p-6 shadow-lg">
                        <h2 id="editorTitle" class="text-xl font-semibold mb-4">မှတ်စုအသစ် ပြုလုပ်ရန်</h2>
                        <input type="text" id="noteTitle" class="w-full text-lg font-semibold px-3 py-2 border-b-2 border-gray-300 focus:outline-none focus:border-blue-500 mb-4 bg-transparent" placeholder="မှတ်စု ခေါင်းစဉ်ထည့်ပါ...">
                        <textarea id="noteResult" class="w-full h-48 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="အသံမှ ပြောင်းထားသော စာသားများ ဤနေရာတွင် ပေါ်လာပါမည်..."></textarea>
                        <div class="mt-4 flex flex-wrap gap-2 justify-end">
                             <button id="formatBtn" class="control-btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 flex items-center gap-2" disabled>
                                ✨ စာသားများ စီစဉ်ရန်
                            </button>
                             <button id="translateBtn" class="control-btn bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 transition-colors duration-300 flex items-center gap-2" disabled>
                                ဘာသာပြန်ရန်
                            </button>
                             <button id="summarizeBtn" class="control-btn bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300 flex items-center gap-2" disabled>
                                အကျဉ်းချုပ်ရန်
                            </button>
                            <button id="saveUpdateBtn" class="control-btn bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 disabled:bg-gray-400 flex items-center gap-2">
                                <svg id="saveIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM5 3a1 1 0 011-1h8a1 1 0 011 1v1h-2V4H6v1H4V3z" /></svg>
                                <span id="saveUpdateText">သိမ်းဆည်းမည်</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Saved Notes List -->
                <div class="lg:col-span-1">
                    <div class="glassmorphism rounded-2xl p-6 shadow-lg h-[30rem] flex flex-col">
                        <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <h2 class="text-xl font-semibold">သိမ်းထားသော မှတ်စုများ</h2>
                            <button id="showGridViewBtn" class="text-blue-600 hover:text-blue-800" title="Grid View">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                            </button>
                        </div>
                        <div class="relative mb-4 flex-shrink-0">
                            <input type="text" id="searchInput" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="မှတ်စုများ ရှာဖွေရန်...">
                            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="notesList" class="space-y-3 overflow-y-auto pr-2 flex-grow">
                            <!-- Saved notes will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-Screen Grid View Modal -->
    <div id="notesGridViewModal" class="fixed inset-0 bg-gray-100 bg-opacity-95 backdrop-blur-sm z-40 p-4 sm:p-8 hidden modal-enter">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-gray-800">မှတ်စုများ အားလုံး</h2>
                <div class="relative w-full sm:w-auto">
                    <input type="text" id="gridSearchInput" class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="မှတ်စုများ ရှာဖွေရန်...">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <button id="closeGridViewBtn" class="bg-white rounded-full p-2 shadow-md hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
             <div id="tagFilterContainer" class="mb-4 flex flex-wrap gap-2">
                <!-- Tags will be injected here -->
            </div>
            <div id="notesGridContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 overflow-y-auto" style="max-height: calc(100vh - 180px);">
                <!-- Grid notes will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Message Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toastMessage"></p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const apiKeyModal = document.getElementById('apiKeyModal'), mainContent = document.getElementById('mainContent'), apiKeyInput = document.getElementById('apiKeyInput'), saveApiKeyBtn = document.getElementById('saveApiKeyBtn'), changeApiKeyBtn = document.getElementById('changeApiKeyBtn');
    const recordBtn = document.getElementById('recordBtn'), recordingStatus = document.getElementById('recordingStatus'), languageSelect = document.getElementById('languageSelect'), loadingSpinner = document.getElementById('loadingSpinner'), recordingControls = document.getElementById('recordingControls');
    const editorTitle = document.getElementById('editorTitle'), noteTitle = document.getElementById('noteTitle'), noteResult = document.getElementById('noteResult');
    const saveUpdateBtn = document.getElementById('saveUpdateBtn'), saveUpdateText = document.getElementById('saveUpdateText'), saveIcon = document.getElementById('saveIcon'), updateIcon = document.getElementById('updateIcon');
    const summarizeBtn = document.getElementById('summarizeBtn'), translateBtn = document.getElementById('translateBtn'), formatBtn = document.getElementById('formatBtn');
    const searchInput = document.getElementById('searchInput'), notesList = document.getElementById('notesList');
    const showGridViewBtn = document.getElementById('showGridViewBtn'), notesGridViewModal = document.getElementById('notesGridViewModal'), notesGridContainer = document.getElementById('notesGridContainer'), closeGridViewBtn = document.getElementById('closeGridViewBtn'), gridSearchInput = document.getElementById('gridSearchInput');
    const toast = document.getElementById('toast'), toastMessage = document.getElementById('toastMessage');
    const uploadBtn = document.getElementById('uploadBtn'), audioUpload = document.getElementById('audioUpload');
    const tagFilterContainer = document.getElementById('tagFilterContainer');
    
    // App State
    let apiKey = '';
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let currentEditingNoteId = null;

    // --- Core Functions ---
    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        toast.className = toast.className.replace(/bg-gray-800|bg-red-600/g, '');
        toast.classList.add(type === 'success' ? 'bg-gray-800' : 'bg-red-600');
        toast.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); }, 3000);
    }

    function setupApiKey() {
        const savedKey = localStorage.getItem('geminiApiKey');
        if (savedKey) {
            apiKey = savedKey;
            apiKeyModal.classList.add('hidden');
            mainContent.classList.remove('hidden');
        } else {
            apiKeyModal.classList.remove('hidden');
            mainContent.classList.add('hidden');
        }
    }

    saveApiKeyBtn.addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        if (key) {
            localStorage.setItem('geminiApiKey', key);
            apiKey = key;
            apiKeyModal.classList.add('hidden');
            mainContent.classList.remove('hidden');
            showToast('API Key ကို အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ။');
        } else {
            showToast('ကျေးဇူးပြု၍ API Key ကို ထည့်သွင်းပါ။', 'error');
        }
    });

    changeApiKeyBtn.addEventListener('click', () => {
        if (confirm('သင်၏ API Key ကို ပြောင်းလဲလိုပါသလား။')) {
            localStorage.removeItem('geminiApiKey');
            apiKey = '';
            apiKeyInput.value = '';
            setupApiKey();
        }
    });

    function showLoading(isLoading, message = '') {
        if (isLoading) {
            uploadBtn.classList.add('hidden');
            recordingControls.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            recordingStatus.textContent = message;
        } else {
            uploadBtn.classList.remove('hidden');
            recordingControls.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            recordingStatus.textContent = '';
        }
    }

    async function toggleRecording() {
        if (isRecording) {
            mediaRecorder.stop();
            recordBtn.classList.remove('pulsate');
            isRecording = false;
        } else {
            try {
                if (currentEditingNoteId === null) { 
                    noteResult.value = '';
                    noteTitle.value = '';
                }
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = async () => {
                    showLoading(true, 'စာသားအဖြစ် ပြောင်းနေသည်...');
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioChunks = [];
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        await transcribeAudio(base64Audio, audioBlob.type);
                        stream.getTracks().forEach(track => track.stop());
                    };
                };
                mediaRecorder.start();
                isRecording = true;
                recordBtn.classList.add('pulsate');
                recordingStatus.textContent = 'အသံသွင်းနေပါသည်...';
            } catch (error) {
                showToast('မိုက်ခရိုဖုန်းကို ဝင်ရောက်ခွင့်မရှိပါ။', 'error');
                recordingStatus.textContent = '';
            }
        }
    }
    recordBtn.addEventListener('click', toggleRecording);

    uploadBtn.addEventListener('click', () => audioUpload.click());

    audioUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            if (currentEditingNoteId === null) { 
                noteResult.value = '';
                noteTitle.value = '';
            }
            showLoading(true, 'အသံဖိုင်ကို စစ်ဆေးနေသည်...');
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];
                await transcribeAudio(base64Audio, file.type);
            };
            reader.onerror = () => {
                showToast('အသံဖိုင်ကို ဖတ်ရာတွင် အမှားအယွင်းဖြစ်ပွားပါသည်။', 'error');
                showLoading(false);
            }
        }
        event.target.value = null;
    });

    async function callGeminiAPI(prompt, base64Audio = null, mimeType = 'audio/webm') {
        if (!apiKey) {
            showToast('API Key မရှိပါ၊ ကျေးဇူးပြု၍ ထည့်သွင်းပါ။', 'error');
            return null;
        }
        const parts = [{ "text": prompt }];
        if (base64Audio) { parts.push({ "inline_data": { "mime_type": mimeType, "data": base64Audio } }); }
        const requestBody = { "contents": [{ "parts": parts }] };
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error('Error with Gemini API:', error);
            showToast(`API Error: ${error.message}`);
            return null;
        }
    }

    async function transcribeAudio(base64Audio, mimeType) {
        const selectedOption = languageSelect.options[languageSelect.selectedIndex];
        const languageName = selectedOption.textContent;
        const prompt = `Please transcribe the following audio. The language is ${languageName}. Provide only the transcribed text.`;
        const text = await callGeminiAPI(prompt, base64Audio, mimeType);
        
        if (text !== null) {
            const cursorPosition = noteResult.selectionStart;
            const currentText = noteResult.value;
            const newText = currentText.slice(0, cursorPosition) + " " + text.trim() + " " + currentText.slice(cursorPosition);
            noteResult.value = newText;
            noteResult.dispatchEvent(new Event('input', { bubbles: true }));
            showToast('စာသားကို အောင်မြင်စွာ ထည့်သွင်းပြီးပါပြီ။');
            
            const generatedTitle = await generateTitle(newText);
            if(generatedTitle) {
                noteTitle.value = generatedTitle;
            }
        }
        showLoading(false);
    }

    async function generateTitle(noteContent) {
        if (!noteContent) return "";
        const selectedOption = languageSelect.options[languageSelect.selectedIndex];
        const languageName = selectedOption.dataset.langName;
        const prompt = `Based on the following text which is in ${languageName}, create a short, concise, and relevant title in the same language (${languageName}). Return only the title text. Text:\n\n${noteContent}`;
        const title = await callGeminiAPI(prompt);
        return title ? title.trim().replace(/"/g, '') : "";
    }

    async function handleSmartFormat() {
        const content = noteResult.value.trim();
        if (!content) return;
        showLoading(true, 'စာသားများ စီစဉ်နေသည်...');
        const selectedOption = languageSelect.options[languageSelect.selectedIndex];
        const languageName = selectedOption.dataset.langName;
        const prompt = `Format the following text which is in ${languageName}. Add appropriate punctuation, paragraphs, and capitalization to make it readable and well-structured. Return only the formatted text. Text:\n\n${content}`;
        const formattedText = await callGeminiAPI(prompt);
        showLoading(false);
        if (formattedText) {
            noteResult.value = formattedText;
            showToast('စာသားများကို အောင်မြင်စွာ စီစဉ်ပြီးပါပြီ။');
        }
    }
    formatBtn.addEventListener('click', handleSmartFormat);

    async function summarizeNote() {
        const content = noteResult.value.trim();
        if (!content) return;
        showLoading(true, 'အကျဉ်းချုပ်နေသည်...');
        const selectedOption = languageSelect.options[languageSelect.selectedIndex];
        const languageName = selectedOption.dataset.langName;
        const prompt = `Summarize the following text in a few key bullet points. The text is written in ${languageName}. The summary MUST also be in ${languageName}. Text: \n\n${content}`;
        const summary = await callGeminiAPI(prompt);
        showLoading(false);
        if (summary !== null) {
            noteResult.value += `\n\n--- အကျဉ်းချုပ် (${languageName}) ---\n${summary.trim()}`;
            noteResult.dispatchEvent(new Event('input', { bubbles: true }));
            showToast('အကျဉ်းချုပ်ပြီးပါပြီ။');
        }
    }
    summarizeBtn.addEventListener('click', summarizeNote);

    async function translateNote() {
        const content = noteResult.value.trim();
        if (!content) return;
        showLoading(true, 'ဘာသာပြန်နေသည်...');
        const selectedOption = languageSelect.options[languageSelect.selectedIndex];
        const currentLang = selectedOption.dataset.langName;
        const targetLang = currentLang === 'Burmese' ? 'English' : 'Burmese';
        const prompt = `Translate the following text to ${targetLang}. Provide only the translated text. Text:\n\n${content}`;
        const translation = await callGeminiAPI(prompt);
        showLoading(false);
        if (translation !== null) {
            noteResult.value += `\n\n--- ဘာသာပြန် (${targetLang}) ---\n${translation.trim()}`;
            noteResult.dispatchEvent(new Event('input', { bubbles: true }));
            showToast('ဘာသာပြန်ပြီးပါပြီ။');
        }
    }
    translateBtn.addEventListener('click', translateNote);

    async function generateTags(noteContent) {
        if (!noteContent) return [];
        showLoading(true, 'Tags များ ဖန်တီးနေသည်...');
        const prompt = `Analyze this text and generate up to 4 relevant, single or two-word tags. Return them as a comma-separated list. Example: #idea, #project, #marketing. Text:\n\n${noteContent}`;
        const tagString = await callGeminiAPI(prompt);
        showLoading(false);
        if (tagString) {
            return tagString.split(',').map(tag => tag.trim().replace(/#/g, ''));
        }
        return [];
    }

    function getNotes() { return JSON.parse(localStorage.getItem('voiceNotes') || '[]'); }
    function saveNotes(notes) { localStorage.setItem('voiceNotes', JSON.stringify(notes)); }

    function renderNotes(notesToRender = null) {
        const notes = notesToRender === null ? getNotes() : notesToRender;
        notesList.innerHTML = '';
        if (notes.length === 0) {
            notesList.innerHTML = `<div class="text-center text-gray-500 py-10"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><p class="mt-2">သိမ်းဆည်းထားသော မှတ်စုများမရှိသေးပါ။</p></div>`;
            return;
        }
        notes.sort((a, b) => b.id - a.id);
        notes.forEach(note => {
            const noteElement = document.createElement('div');
            noteElement.className = 'note-item bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-all duration-300 flex justify-between items-start';
            if (note.id === currentEditingNoteId) { noteElement.classList.add('selected'); }
            noteElement.dataset.id = note.id;
            noteElement.innerHTML = `<div class="overflow-hidden"><h4 class="font-bold truncate">${note.title}</h4><p class="text-sm text-gray-600 truncate">${note.content.substring(0, 50)}...</p></div><button class="delete-icon opacity-0 text-red-500 hover:text-red-700 transition-opacity flex-shrink-0 ml-2" data-id="${note.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
            notesList.appendChild(noteElement);
        });
    }

    async function handleSaveOrUpdate() {
        const title = noteTitle.value.trim();
        const content = noteResult.value.trim();
        if (!title || !content) {
            showToast('ကျေးဇူးပြု၍ ခေါင်းစဉ်နှင့် မှတ်စုအကြောင်းအရာကို ဖြည့်စွက်ပါ။', 'error');
            return;
        }
        
        let notes = getNotes();
        let tags = [];
        if (currentEditingNoteId === null) { 
            tags = await generateTags(content);
        }

        if (currentEditingNoteId === null) {
            const newNote = { id: Date.now(), title, content, tags: tags || [] };
            notes.push(newNote);
            showToast('မှတ်စုကို အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ။');
        } else {
            const noteIndex = notes.findIndex(note => note.id === currentEditingNoteId);
            if (noteIndex > -1) { 
                notes[noteIndex].title = title;
                notes[noteIndex].content = content;
             }
            showToast('မှတ်စုကို အောင်မြင်စွာ ပြင်ဆင်ပြီးပါပြီ။');
        }
        saveNotes(notes);
        clearInputs();
        renderNotes();
        renderTagFilters();
    }
    saveUpdateBtn.addEventListener('click', handleSaveOrUpdate);
    
    notesList.addEventListener('click', (e) => {
        const noteItem = e.target.closest('.note-item');
        const deleteBtn = e.target.closest('.delete-icon');
        if (deleteBtn) {
            e.stopPropagation();
            const noteId = parseInt(deleteBtn.dataset.id);
            if (confirm('ဒီမှတ်စုကို ဖျက်မှာ သေချာပါသလား။')) {
                let notes = getNotes();
                notes = notes.filter(note => note.id !== noteId);
                saveNotes(notes);
                if (currentEditingNoteId === noteId) { clearInputs(); }
                renderNotes();
                renderTagFilters();
                showToast('မှတ်စုကို ဖျက်လိုက်ပါပြီ။');
            }
        } else if (noteItem) {
            const noteId = parseInt(noteItem.dataset.id);
            const notes = getNotes();
            const noteToDisplay = notes.find(note => note.id === noteId);
            if (noteToDisplay) {
                noteTitle.value = noteToDisplay.title;
                noteResult.value = noteToDisplay.content;
                currentEditingNoteId = noteToDisplay.id;
                updateButtonState('edit');
            }
        }
    });
    
    function updateButtonState(mode = 'new') {
        const hasContent = noteResult.value.trim().length > 0;
        saveUpdateBtn.disabled = !hasContent;
        summarizeBtn.disabled = !hasContent;
        translateBtn.disabled = !hasContent;
        formatBtn.disabled = !hasContent;
        if (mode === 'edit' && hasContent) {
            editorTitle.textContent = "မှတ်စုကို တည်းဖြတ်ရန်";
            saveUpdateText.textContent = "ပြင်ဆင်မည်";
        } else {
            editorTitle.textContent = "မှတ်စုအသစ် ပြုလုပ်ရန်";
            saveUpdateText.textContent = "သိမ်းဆည်းမည်";
        }
        renderNotes();
    }

    noteResult.addEventListener('input', () => updateButtonState(currentEditingNoteId ? 'edit' : 'new'));
    noteTitle.addEventListener('input', () => updateButtonState(currentEditingNoteId ? 'edit' : 'new'));

    function clearInputs() {
        noteTitle.value = '';
        noteResult.value = '';
        currentEditingNoteId = null;
        updateButtonState('new');
    }
    
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const allNotes = getNotes();
        const filteredNotes = allNotes.filter(note => note.title.toLowerCase().includes(searchTerm) || note.content.toLowerCase().includes(searchTerm));
        renderNotes(filteredNotes);
    });

    // --- Grid & Tag Logic ---
    function renderTagFilters() {
        const allNotes = getNotes();
        const tagCounts = {};
        allNotes.forEach(note => {
            if (note.tags && Array.isArray(note.tags)) {
                note.tags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            }
        });

        const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
        const topTags = sortedTags.slice(0, 10);

        tagFilterContainer.innerHTML = '';

        const showAllBtn = document.createElement('button');
        showAllBtn.className = 'tag-badge bg-blue-500 text-white px-3 py-1 rounded-full text-sm';
        showAllBtn.textContent = 'အားလုံး';
        showAllBtn.onclick = () => renderGridView();
        tagFilterContainer.appendChild(showAllBtn);

        topTags.forEach(tag => {
            const tagBtn = document.createElement('button');
            tagBtn.className = 'tag-badge bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm';
            tagBtn.textContent = tag;
            tagBtn.onclick = () => {
                const filtered = allNotes.filter(note => note.tags && note.tags.includes(tag));
                renderGridView(filtered);
            };
            tagFilterContainer.appendChild(tagBtn);
        });
    }

    function renderGridView(notesToRender = null) {
        const notes = notesToRender === null ? getNotes() : notesToRender;
        notesGridContainer.innerHTML = '';
        if (notes.length === 0) {
            notesGridContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center mt-10">မှတ်စုများ မရှိသေးပါ။</p>`;
            return;
        }
        notes.sort((a, b) => b.id - a.id);
        notes.forEach(note => {
            const gridCard = document.createElement('div');
            gridCard.className = 'grid-note-card bg-white rounded-lg p-4 shadow-md cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between';
            gridCard.dataset.id = note.id;

            const tagsHTML = (note.tags && note.tags.length > 0) 
                ? `<div class="flex flex-wrap gap-1 mb-2">${note.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${tag}</span>`).join('')}</div>`
                : '';

            gridCard.innerHTML = `
                <div>
                    ${tagsHTML}
                    <h4 class="font-bold text-lg mb-2 truncate">${note.title}</h4>
                    <p class="text-sm text-gray-600">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</p>
                </div>
                <div class="flex justify-between items-center mt-4">
                     <p class="text-xs text-gray-400">${new Date(note.id).toLocaleDateString()}</p>
                     <button class="delete-grid-item-icon text-gray-400 hover:text-red-500" data-id="${note.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                     </button>
                </div>
            `;
            notesGridContainer.appendChild(gridCard);
        });
    }

    showGridViewBtn.addEventListener('click', () => {
        gridSearchInput.value = '';
        renderGridView();
        renderTagFilters();
        notesGridViewModal.classList.remove('hidden');
        notesGridViewModal.classList.add('modal-enter', 'modal-enter-active');
    });

    closeGridViewBtn.addEventListener('click', () => {
        notesGridViewModal.classList.remove('modal-enter-active');
        notesGridViewModal.classList.add('modal-leave-active');
        setTimeout(() => {
            notesGridViewModal.classList.add('hidden');
            notesGridViewModal.classList.remove('modal-leave-active');
        }, 200);
    });

    notesGridContainer.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-grid-item-icon');
        const gridCard = e.target.closest('.grid-note-card');

        if(deleteBtn){
            e.stopPropagation();
            const noteId = parseInt(deleteBtn.dataset.id);
            if (confirm('ဒီမှတ်စုကို ဖျက်မှာ သေချာပါသလား။')) {
                let notes = getNotes();
                notes = notes.filter(note => note.id !== noteId);
                saveNotes(notes);
                if (currentEditingNoteId === noteId) { clearInputs(); }
                renderGridView(getNotes());
                renderNotes();
                renderTagFilters();
                showToast('မှတ်စုကို ဖျက်လိုက်ပါပြီ။');
            }
        }
        else if (gridCard) {
            const noteId = parseInt(gridCard.dataset.id);
            const notes = getNotes();
            const noteToDisplay = notes.find(note => note.id === noteId);
            if (noteToDisplay) {
                noteTitle.value = noteToDisplay.title;
                noteResult.value = noteToDisplay.content;
                currentEditingNoteId = noteToDisplay.id;
                updateButtonState('edit');
                closeGridViewBtn.click();
            }
        }
    });
    
    gridSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const allNotes = getNotes();
        const filteredNotes = allNotes.filter(note => 
            note.title.toLowerCase().includes(searchTerm) || 
            note.content.toLowerCase().includes(searchTerm)
        );
        renderGridView(filteredNotes);
    });

    function init() {
        setupApiKey();
        renderNotes();
        updateButtonState();
        renderTagFilters();
    }
    init();
});
</script>

</body>
</html>
